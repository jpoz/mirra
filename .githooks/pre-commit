#!/bin/sh
# Pre-commit hook for mirra
# Runs gofmt and go vet on staged Go files

set -e

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "No Go files staged for commit"
    exit 0
fi

echo "Running pre-commit checks on staged Go files..."

# Run gofmt on staged files
echo "→ Running gofmt..."
UNFORMATTED=$(echo "$STAGED_GO_FILES" | xargs gofmt -l)
if [ -n "$UNFORMATTED" ]; then
    echo "❌ gofmt found unformatted files:"
    echo "$UNFORMATTED"
    echo ""
    echo "Please run: gofmt -w $UNFORMATTED"
    echo "Or run: make fmt"
    exit 1
fi
echo "✓ gofmt passed"

# Run go vet on staged files
echo "→ Running go vet..."
echo "$STAGED_GO_FILES" | xargs -I {} dirname {} | sort -u | xargs -I {} go vet ./{}
echo "✓ go vet passed"

echo "✓ All pre-commit checks passed"
exit 0
